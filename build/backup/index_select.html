<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>AI Chat</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				padding: 20px;
				background: white;
			}
			/* 用户消息样式 */
			.user-message {
				background-color: #ffffff;
				color: #000000;
				border-radius: 12px;
				padding: 8px 16px;
				max-width: 60%;
				border-bottom-right-radius: 0; /* 用户消息右下角圆角 */
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* 消息阴影 */
				align-self: flex-start; /* 靠右显示 */
			}

			/* AI消息样式 */
			.ai-message {
				background-color: #e6e6fa; /* 淡紫色背景 */
				color: #000000;
				border-radius: 12px;
				padding: 8px 16px;
				max-width: 60%;
				border-bottom-left-radius: 0; /* AI消息右下角圆角 */
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* 消息阴影 */
				align-self: flex-end; /* 靠左显示 */
			}
			.input-part {
				display: flex;
				margin-top: 30px;
				margin-left: 5%;
			}
			#chat-container {
				background-color: rgb(220, 222, 252);
				padding-top: 15px;
				margin-top: 5px;
				margin-left: 1%;
				width: 98%;
				height: 300px;
				padding-left: 20px;
				font-family: 'PingFang SC/TC', 'Microsoft YaHei';
				border-radius: 10px 10px 10px 10px;
				overflow-y: scroll; /* 保留滚动条 */
				scrollbar-width: thin; /* 适用于WebKit浏览器 */
				scrollbar-color: rgba(255, 255, 255, 0) rgba(255, 253, 253, 0); /* 滚动条颜色 */
				display: flex;
				flex-direction: column;
				align-items: flex-start;
				gap: 8px; /* 消息之间的间距 */
			}
			#message-input {
				border: 1px solid #dfe1e5;
				font-family: 'PingFang SC/TC', 'Microsoft YaHei';
				padding-left: 18px;
				outline: none;
				width: 80%;
				height: 32px;
				border-radius: 20px 0 0 20px;
			}
			#send-button {
				text-align: center;
				background: linear-gradient(to right, hsl(240, 69%, 71%), hsl(270, 64%, 67%)); /* 使用渐变色作为背景 */
				font-family: 'PingFang SC/TC', 'Microsoft YaHei';
				font-size: 18px;
				color: rgba(255, 255, 255, 0.87);
				width: 15%;
				height: 35px;
				border-radius: 0 20px 20px 0;
				border: none; /* 去除边框 */
				cursor: pointer;
				user-select: none;
			}
			.api-url {
				margin-top: 20px;
				color: rgb(149, 151, 180);
				font-size: medium;
				font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
			}
			#api-url-input {
				border: 1px solid #dfe1e5;
				color: rgb(149, 151, 180);
				padding-left: 6px;
				outline: none;
				width: 85%;
				height: 20px;
				border-radius: 0 0 0 0;
				font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
			}
			.api-key {
				margin-top: 20px;
				color: rgb(149, 151, 180);
				font-size: medium;
				font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
			}
			#api-key-input {
				border: 1px solid #dfe1e5;
				color: rgb(149, 151, 180);
				padding-left: 6px;
				outline: none;
				width: 85%;
				height: 20px;
				border-radius: 0 0 0 0;
				font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
			}
		</style>
	</head>
	<body>
		<div class="index">
			<button id="greet-button">元件选取</button>
			<div id="chat-container"></div>

			<div class="input-part">
				<input type="text" id="message-input" placeholder="在这输入你的问题..." />
				<button id="send-button">发送</button>
			</div>

			<div class="api-url">
				<label for="api-url">URL</label>
				<input type="text" id="api-url-input" placeholder="" />
			</div>

			<div class="api-key">
				<label for="api-key">KEY</label>
				<input type="text" id="api-key-input" placeholder="" />
			</div>
		</div>

		<script>
			document.addEventListener('DOMContentLoaded', async () => {
				const chatContainer = document.getElementById('chat-container');
				const messageInput = document.getElementById('message-input');
				const sendButton = document.getElementById('send-button');
				const apiUrlInput = document.getElementById('api-url-input');
				const apiKeyInput = document.getElementById('api-key-input');
				const greetButton = document.getElementById('greet-button'); // 选取元件按钮

				let id = 0;
				let isSelectingComponent = true; // 标记是否处于选择元件状态

				async function sendMessage(event) {
					id++;
					event.preventDefault();
					const message = messageInput.value.trim();
					if (message) {
						displayMessage(`${message}`, null, true);
						messageInput.value = '';

						const apiUrl = apiUrlInput.value;
						const apiKey = apiKeyInput.value;
						const response = await fetch(apiUrl, {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
								'Authorization': `Bearer ${apiKey}`,
							},
							body: JSON.stringify({
								model: 'moonshot-v1-32k',
								messages: [{ role: 'user', content: message }],
								temperature: 0.3,
								stream: true,
							}),
						});

						const reader = response.body.getReader();
						while (true) {
							const { done, value } = await reader.read();
							if (done) {
								break;
							} else {
								const decoder = new TextDecoder();
								const chunk = decoder.decode(value, { stream: true });
								const lines = chunk.split('\n');
								lines.forEach((line) => {
									if (line.startsWith('data: ')) {
										const data = line.substring(6);
										if (data === '[DONE]') {
											//...
										} else {
											try {
												const chunkJson = JSON.parse(data);
												const content = chunkJson.choices[0].delta.content;
												if (content) {
													displayMessage(content, id, false); // 立即显示接收到的数据块
												}
											} catch (error) {
												console.error('Error parsing chunk:', error);
											}
										}
									}
								});
							}
						}
					}
				}

				async function sendGreeting() {
					if (isSelectingComponent) {
						greetButton.textContent = '点击元件';

						eda.sch_Event.addMouseEventListener(
							'1',
							'selected',
							async (eventType) => {
								const selectedPrimitives = await eda.sch_SelectControl.getSelectedPrimitives();
								if (selectedPrimitives.length > 0) {
									const id = selectedPrimitives[0].id;
									const primitiveComponent = await eda.sch_PrimitiveComponent.get(id);
									if (primitiveComponent.length > 0) {
										console.log(primitiveComponent[0].name);
										const message = `请介绍 ${primitiveComponent[0].name} 的功能及应用场景`;
										messageInput.value = message;
										sendMessage({ preventDefault: () => {} });
									}
								}
							},
							1,
						);

						greetButton.textContent = '元件选取';
					}
				}

				function displayMessage(message, id, user) {
					message = message.replaceAll('\n', '<br />');

					let messageDiv;
					if (id) {
						messageDiv = document.getElementById(id);
						if (!messageDiv) {
							messageDiv = document.createElement('div');
							messageDiv.setAttribute('id', id);
						}
					} else {
						messageDiv = document.createElement('div');
					}
					if (user) {
						messageDiv.style.marginLeft = 'auto'; // AI消息靠左
						messageDiv.className = 'user-message';
					} else {
						messageDiv.style.marginRight = 'auto'; // 用户消息靠右
						messageDiv.className = 'ai-message';
					}
					messageDiv.innerHTML += message;

					// 如果messageDiv不在DOM中，则添加到chatContainer
					if (!messageDiv.parentNode) {
						chatContainer.appendChild(messageDiv);
					}

					chatContainer.scrollTop = chatContainer.scrollHeight;
				}

				sendButton.addEventListener('click', sendMessage);
				messageInput.addEventListener('keypress', (event) => {
					if (event.key === 'Enter') {
						sendMessage(event);
					}
				});

				// 为按钮添加事件监听器
				greetButton.addEventListener('click', sendGreeting);
			});
		</script>
	</body>
</html>
