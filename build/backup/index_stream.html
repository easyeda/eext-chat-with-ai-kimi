<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>AI Chat</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				padding: 20px;
			}
			#chat-container {
				border: 1px solid #ccc;
				height: 300px;
				overflow-y: scroll;
				padding: 10px;
			}
			#message-input {
				width: calc(100% - 110px);
				padding: 10px;
				margin-right: 10px;
			}
			#send-button {
				padding: 10px 20px;
			}
		</style>
	</head>
	<body>
		<div id="chat-container"></div>
		<input type="text" id="message-input" placeholder="Type your message here..." />
		<button id="send-button">Send</button>

		<script>
			document.addEventListener('DOMContentLoaded', async () => {
				const chatContainer = document.getElementById('chat-container');
				const messageInput = document.getElementById('message-input');
				const sendButton = document.getElementById('send-button');

				let id = 0;

				async function sendMessage(event) {
					id++;
					event.preventDefault();
					const message = messageInput.value.trim();
					if (message) {
						displayMessage(`You: ${message}`);
						messageInput.value = '';

						const response = await fetch('https://api.moonshot.cn/v1/chat/completions', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
								'Authorization': 'Bearer sk-KRJ9vaCTGeXUqzLEbi13XXHbmrDZFQJVu8bzup7JRW0oOXiR',
							},
							body: JSON.stringify({
								model: 'moonshot-v1-8k',
								messages: [{ role: 'user', content: message }],
								temperature: 0.3,
								stream: true,
							}),
						});

						const reader = response.body.getReader();
						while (true) {
							const { done, value } = await reader.read();
							if (done) {
								break;
							} else {
								const decoder = new TextDecoder();
								const chunk = decoder.decode(value, { stream: true });
								const lines = chunk.split('\n');
								lines.forEach((line) => {
									if (line.startsWith('data: ')) {
										const data = line.substring(6);
										if (data === '[DONE]') {
											displayNewLine(); // 在AI回复结束时添加换行
										} else {
											try {
												const chunkJson = JSON.parse(data);
												const content = chunkJson.choices[0].delta.content;
												if (content) {
													displayMessage(content, id); // 立即显示接收到的数据块
												}
											} catch (error) {
												console.error('Error parsing chunk:', error);
											}
										}
									}
								});
							}
						}
					}
				}

				function displayMessage(message, id) {
					message = message.replaceAll('\n', '<br />');
					let messageDiv = undefined;
					if (id) {
						messageDiv = document.getElementById(id);
						if (!messageDiv) {
							messageDiv = document.createElement('div');
							messageDiv.setAttribute('id', id);
							messageDiv.innerHTML = 'AI: ' + message;
							chatContainer.appendChild(messageDiv);
						} else {
							messageDiv.innerHTML = messageDiv.innerHTML + message;
						}
					} else {
						messageDiv = document.createElement('div');
						messageDiv.innerHTML = message;
						chatContainer.appendChild(messageDiv);
					}

					chatContainer.scrollTop = chatContainer.scrollHeight;
				}

				function displayNewLine() {
					const newLineDiv = document.createElement('div');
					newLineDiv.textContent = '\n';
					chatContainer.appendChild(newLineDiv);
					chatContainer.scrollTop = chatContainer.scrollHeight;
				}

				sendButton.addEventListener('click', sendMessage);
				messageInput.addEventListener('keypress', (event) => {
					if (event.key === 'Enter') {
						sendMessage(event);
					}
				});
			});
		</script>
	</body>
</html>
